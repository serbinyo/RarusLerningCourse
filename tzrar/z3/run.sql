-- MySQL Script generated by MySQL Workbench
-- Thu Aug  2 15:13:57 2018
-- Model: New Model    Version: 1.0
-- MySQL Workbench Forward Engineering

SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=0;
SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0;
SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE='TRADITIONAL,ALLOW_INVALID_DATES';

-- -----------------------------------------------------
-- Schema tzrar_z3
-- -----------------------------------------------------

-- -----------------------------------------------------
-- Schema tzrar_z3
-- -----------------------------------------------------
CREATE SCHEMA IF NOT EXISTS `tzrar_z3` DEFAULT CHARACTER SET utf8 ;
USE `tzrar_z3` ;

-- -----------------------------------------------------
-- Table `tzrar_z3`.`author`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `tzrar_z3`.`author` (
  `id` INT NOT NULL AUTO_INCREMENT,
  `firstname` VARCHAR(45) NULL,
  `lastname` VARCHAR(45) NOT NULL,
  PRIMARY KEY (`id`))
ENGINE = InnoDB;


-- -----------------------------------------------------
-- Table `tzrar_z3`.`book`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `tzrar_z3`.`book` (
  `id` INT NOT NULL AUTO_INCREMENT,
  `isbn` VARCHAR(45) NOT NULL,
  `name` VARCHAR(45) NOT NULL,
  `pages` VARCHAR(45) NULL,
  `date` DATE NOT NULL,
  PRIMARY KEY (`id`))
ENGINE = InnoDB;


-- -----------------------------------------------------
-- Table `tzrar_z3`.`genre`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `tzrar_z3`.`genre` (
  `id` INT NOT NULL AUTO_INCREMENT,
  `name` VARCHAR(45) NOT NULL,
  PRIMARY KEY (`id`))
ENGINE = InnoDB;


-- -----------------------------------------------------
-- Table `tzrar_z3`.`book_author`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `tzrar_z3`.`book_author` (
  `book_id` INT NOT NULL,
  `author_id` INT NOT NULL,
  PRIMARY KEY (`book_id`, `author_id`),
  INDEX `fk_book_author_author1_idx` (`author_id` ASC),
  CONSTRAINT `fk_book_author_book`
    FOREIGN KEY (`book_id`)
    REFERENCES `tzrar_z3`.`book` (`id`)
    ON DELETE CASCADE
    ON UPDATE CASCADE,
  CONSTRAINT `fk_book_author_author1`
    FOREIGN KEY (`author_id`)
    REFERENCES `tzrar_z3`.`author` (`id`)
    ON DELETE CASCADE
    ON UPDATE CASCADE)
ENGINE = InnoDB;


-- -----------------------------------------------------
-- Table `tzrar_z3`.`book_genre`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `tzrar_z3`.`book_genre` (
  `book_id` INT NOT NULL,
  `genre_id` INT NOT NULL,
  PRIMARY KEY (`book_id`, `genre_id`),
  INDEX `fk_book_genre_genre1_idx` (`genre_id` ASC),
  CONSTRAINT `fk_book_genre_book1`
    FOREIGN KEY (`book_id`)
    REFERENCES `tzrar_z3`.`book` (`id`)
    ON DELETE CASCADE
    ON UPDATE CASCADE,
  CONSTRAINT `fk_book_genre_genre1`
    FOREIGN KEY (`genre_id`)
    REFERENCES `tzrar_z3`.`genre` (`id`)
    ON DELETE CASCADE
    ON UPDATE CASCADE)
ENGINE = InnoDB;


SET SQL_MODE=@OLD_SQL_MODE;
SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS;
SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS;

-- -----------------------------------------------------
-- Data for table `tzrar_z3`.`author`
-- -----------------------------------------------------
START TRANSACTION;
USE `tzrar_z3`;
INSERT INTO `tzrar_z3`.`author` (`id`, `firstname`, `lastname`) VALUES (1, 'Федор ', 'Достоевский');
INSERT INTO `tzrar_z3`.`author` (`id`, `firstname`, `lastname`) VALUES (2, 'Илья ', 'Ильф');
INSERT INTO `tzrar_z3`.`author` (`id`, `firstname`, `lastname`) VALUES (3, 'Александр ', 'Пушкин');
INSERT INTO `tzrar_z3`.`author` (`id`, `firstname`, `lastname`) VALUES (4, 'Лев ', 'Толстой');
INSERT INTO `tzrar_z3`.`author` (`id`, `firstname`, `lastname`) VALUES (5, 'Евгений ', 'Петров');
INSERT INTO `tzrar_z3`.`author` (`id`, `firstname`, `lastname`) VALUES (6, 'Аркадий ', 'Стругацкий');
INSERT INTO `tzrar_z3`.`author` (`id`, `firstname`, `lastname`) VALUES (7, 'Сергей ', 'Лукьяненко');
INSERT INTO `tzrar_z3`.`author` (`id`, `firstname`, `lastname`) VALUES (8, 'Владимир ', 'Васильев');
INSERT INTO `tzrar_z3`.`author` (`id`, `firstname`, `lastname`) VALUES (9, 'Борис ', 'Стругацкий');

COMMIT;


-- -----------------------------------------------------
-- Data for table `tzrar_z3`.`book`
-- -----------------------------------------------------
START TRANSACTION;
USE `tzrar_z3`;
INSERT INTO `tzrar_z3`.`book` (`id`, `isbn`, `name`, `pages`, `date`) VALUES (1, '978-5-457-15151-2', 'Дневной Дозор', '452', '2000-02-13');
INSERT INTO `tzrar_z3`.`book` (`id`, `isbn`, `name`, `pages`, `date`) VALUES (2, '978-5-389-01463-3', 'Братья Карамазовы', '800', '2015-01-01');
INSERT INTO `tzrar_z3`.`book` (`id`, `isbn`, `name`, `pages`, `date`) VALUES (3, '978-5-699-08860-7', 'Война и мир', '1274', '2004-06-25');
INSERT INTO `tzrar_z3`.`book` (`id`, `isbn`, `name`, `pages`, `date`) VALUES (4, '978-5-249-05782-1', 'Подробности жизни Никиты Воронцова', '363', '1999-10-10');
INSERT INTO `tzrar_z3`.`book` (`id`, `isbn`, `name`, `pages`, `date`) VALUES (5, '978-5-249-09741-4', 'Понедельник начинается в субботу', '434', '2002-02-11');
INSERT INTO `tzrar_z3`.`book` (`id`, `isbn`, `name`, `pages`, `date`) VALUES (6, '978-5-102-71465-3', 'Евгений Онегин', '320', '2018-09-03');
INSERT INTO `tzrar_z3`.`book` (`id`, `isbn`, `name`, `pages`, `date`) VALUES (7, '978-5-17-074966-9', 'Двенадцать стульев', '608', '2011-08-23');
INSERT INTO `tzrar_z3`.`book` (`id`, `isbn`, `name`, `pages`, `date`) VALUES (8, '978-5-389-07127-8', 'Игрок', '416', '2014-05-17');
INSERT INTO `tzrar_z3`.`book` (`id`, `isbn`, `name`, `pages`, `date`) VALUES (9, '978-5-699-74925-6', 'Сказки', '120', '2016-03-02');
INSERT INTO `tzrar_z3`.`book` (`id`, `isbn`, `name`, `pages`, `date`) VALUES (10, '978-5-389-04926-0', 'Преступление и наказание', '608', '2013-08-31');

COMMIT;


-- -----------------------------------------------------
-- Data for table `tzrar_z3`.`genre`
-- -----------------------------------------------------
START TRANSACTION;
USE `tzrar_z3`;
INSERT INTO `tzrar_z3`.`genre` (`id`, `name`) VALUES (1, 'Роман');
INSERT INTO `tzrar_z3`.`genre` (`id`, `name`) VALUES (2, 'Драма');
INSERT INTO `tzrar_z3`.`genre` (`id`, `name`) VALUES (3, 'Приключение');
INSERT INTO `tzrar_z3`.`genre` (`id`, `name`) VALUES (4, 'Фантастика');
INSERT INTO `tzrar_z3`.`genre` (`id`, `name`) VALUES (5, 'Сказки');
INSERT INTO `tzrar_z3`.`genre` (`id`, `name`) VALUES (6, 'Комедия');

COMMIT;


-- -----------------------------------------------------
-- Data for table `tzrar_z3`.`book_author`
-- -----------------------------------------------------
START TRANSACTION;
USE `tzrar_z3`;
INSERT INTO `tzrar_z3`.`book_author` (`book_id`, `author_id`) VALUES (1, 7);
INSERT INTO `tzrar_z3`.`book_author` (`book_id`, `author_id`) VALUES (1, 8);
INSERT INTO `tzrar_z3`.`book_author` (`book_id`, `author_id`) VALUES (2, 1);
INSERT INTO `tzrar_z3`.`book_author` (`book_id`, `author_id`) VALUES (3, 4);
INSERT INTO `tzrar_z3`.`book_author` (`book_id`, `author_id`) VALUES (4, 6);
INSERT INTO `tzrar_z3`.`book_author` (`book_id`, `author_id`) VALUES (5, 9);
INSERT INTO `tzrar_z3`.`book_author` (`book_id`, `author_id`) VALUES (5, 6);
INSERT INTO `tzrar_z3`.`book_author` (`book_id`, `author_id`) VALUES (6, 3);
INSERT INTO `tzrar_z3`.`book_author` (`book_id`, `author_id`) VALUES (7, 2);
INSERT INTO `tzrar_z3`.`book_author` (`book_id`, `author_id`) VALUES (7, 5);
INSERT INTO `tzrar_z3`.`book_author` (`book_id`, `author_id`) VALUES (8, 1);
INSERT INTO `tzrar_z3`.`book_author` (`book_id`, `author_id`) VALUES (9, 3);
INSERT INTO `tzrar_z3`.`book_author` (`book_id`, `author_id`) VALUES (10, 1);

COMMIT;


-- -----------------------------------------------------
-- Data for table `tzrar_z3`.`book_genre`
-- -----------------------------------------------------
START TRANSACTION;
USE `tzrar_z3`;
INSERT INTO `tzrar_z3`.`book_genre` (`book_id`, `genre_id`) VALUES (1, 1);
INSERT INTO `tzrar_z3`.`book_genre` (`book_id`, `genre_id`) VALUES (1, 4);
INSERT INTO `tzrar_z3`.`book_genre` (`book_id`, `genre_id`) VALUES (2, 1);
INSERT INTO `tzrar_z3`.`book_genre` (`book_id`, `genre_id`) VALUES (2, 2);
INSERT INTO `tzrar_z3`.`book_genre` (`book_id`, `genre_id`) VALUES (3, 1);
INSERT INTO `tzrar_z3`.`book_genre` (`book_id`, `genre_id`) VALUES (4, 4);
INSERT INTO `tzrar_z3`.`book_genre` (`book_id`, `genre_id`) VALUES (5, 4);
INSERT INTO `tzrar_z3`.`book_genre` (`book_id`, `genre_id`) VALUES (6, 1);
INSERT INTO `tzrar_z3`.`book_genre` (`book_id`, `genre_id`) VALUES (7, 1);
INSERT INTO `tzrar_z3`.`book_genre` (`book_id`, `genre_id`) VALUES (8, 1);
INSERT INTO `tzrar_z3`.`book_genre` (`book_id`, `genre_id`) VALUES (9, 5);
INSERT INTO `tzrar_z3`.`book_genre` (`book_id`, `genre_id`) VALUES (10, 1);

COMMIT;

-- -----------------------------------------------------
-- Запрос 1. Вывести название книги и ее авторов для жанра “Фантастика”.
-- -----------------------------------------------------
SELECT book.name as Book, group_concat(author.firstname, author.lastname SEPARATOR ',  ') as Authors
	FROM author
join book_author
	on author.id = book_author.author_id
join book
	on book.id = book_author.book_id
join book_genre
	on book.id = book_genre.book_id
join genre
	on genre.id = book_genre.genre_id
where
	genre.name = "Фантастика"
group by book.name;


-- -----------------------------------------------------
-- Запрос 2. Вывести автора, который написал больше всего книг
-- -----------------------------------------------------
SELECT author.firstname, author.lastname, count(book.name) as n_books
	FROM author
join book_author
	on author.id = book_author.author_id
join book
	on book.id = book_author.book_id
group by author.firstname, author.lastname
order by n_books desc
limit 1;
